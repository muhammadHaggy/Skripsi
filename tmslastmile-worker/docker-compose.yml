version: "3.9"

services:
  tmslastmile_worker:
    image: python:3.10-slim
    container_name: tmslastmile_worker
    working_dir: /app
    env_file:
      - .env
    environment:
      # Connect to RabbitMQ running in the api-gateway compose
      - RABBITMQ_URL=amqp://guest:guest@api_gateway_rabbitmq:5672/
      # Ensure these align with api-gateway/.env
      - EXCHANGE=box_exchange
      - ROUTING_KEY=box.job
      - AUDIT_KEY=box.audit
      # Post results back to api-gateway service by name on shared network
      - BACKEND_API=http://api_gateway:8080/api/v1/box/dimension-result
      # Point worker to mounted machine-learning directory
      - ML_ROOT=/ml
      # Optionally override to point to a specific Python interpreter; defaults to container's Python
      # - PYTHON_PATH=/usr/local/bin/python
    volumes:
      # Mount worker code
      - ./:/app
      # Mount host machine-learning project so scripts/data are accessible
      - ../machine-learning:/ml:rw
    extra_hosts:
      # Allow reaching host services via host.docker.internal (useful for storage URLs)
      - "host.docker.internal:host-gateway"
    command: sh -c "pip install --no-cache-dir -r requirements.txt && python main.py"
    networks:
      - api_gateway_net

networks:
  api_gateway_net:
    external: true
    # This must match the network name created by `api-gateway/docker-compose.yml`
    name: api-gateway_default


